let moodlequizeditor=function(){let e="untitled.gift",l=0;function a(e){let t="";var i="single"===e.type?"checked":"",n="multiple"===e.type?"checked":"";e.qitem.forEach(function(e){t=t+'<div class="qi valign-wrapper offset-s2 col s9"><p><label><input type="checkbox" '+(e.result?'checked="checked"':"")+'><span><input type="text" value="'+e.text+'"></span></label></p><a nohref title="Удалить ответ" class="control-item-delete" onclick="moodlequizeditor.deleteItem(this)"><i class="material-icons">highlight_off</i></a></div>'}),t+='<div class="qi valign-wrapper offset-s10 col s1 right-align"><a nohref title="Добавить ответ" class="control-item-add" onclick="moodlequizeditor.addItem(this)"><i class="material-icons green-text">add_circle_outline</i></a></div>';i='<div class="qw" id="qw'+e.qid+'"><div class="row"><div class="valign-wrapper offset-s1 col s10"><input type="text" class="qn" value="'+e.qname+'" onkeyup="moodlequizeditor.changeList(this,'+e.qid+')"><a nohref title="Удалить вопрос" class="control-name-delete" onclick="moodlequizeditor.deleteQuestion(this,'+e.qid+')"><i class="material-icons red-text lighten-4">highlight_off</i></a></div></div><div class="row"><div class="offset-s1 col s11 p0 center-align qt"><label><input name="qtype'+e.qid+'" type="radio" data-type="multiple" '+n+' /><span>Несколько правильных</span></label><label><input name="qtype'+e.qid+'" data-type="single" type="radio" '+i+" /><span>Один правильный</span></label></div>"+t+"</div>";$("#qlist").append('<li id="ql'+e.qid+'" class="sidenav-close"><a href="#qw'+e.qid+'">'+e.qname+"</a></li>"),$(".addnew").before(i)}function t(){e="untitled.gift",l=0,$("#inputfile").val(""),$("#wrapper").empty(),$("#qlist").empty(),$("#wrapper").append('<a class="btn-floating btn-large waves-effect waves-light red addnew" nohref onclick="moodlequizeditor.addNewQuestion()" title="Добавить новый вопрос"><i class="material-icons">add</i></a>')}function i(e){n(!0);let t=new FileReader;t.onload=function(e){mammoth.extractRawText({arrayBuffer:e.target.result}).then(function(e){!function(e){let i=-1,n=[];e.split("\n").forEach(function(e){var t;0<e.length&&(null===(t=e.match(/(\-?[\d|\.]+)\%(.+)/))?(0<=i&&(a(n),n=[]),i++,n={qid:i,qname:e,qitem:[],type:"multiple"}):0<t.length&&n.qitem.push({text:t[2],result:0<parseInt(t[1])}))}),l=i+1,a(n)}(e.value)}).done(n(!1))},t.readAsArrayBuffer(e.files[0])}function n(e){e?$(".progress").show():$(".progress").hide()}function o(){let o="";$("#wrapper").find(".qw").each(function(e,t){var i=$(t).find(".qn:first").val();if(0<i.length){o=o+i+" {\n";let n=0,l=!1;$(t).find(".qi").each(function(e,t){n+=$(t).find('input[type="checkbox"]:first').is(":checked")?1:0});var a=$(t).find("input[type='radio'][name^='qtype']:checked").first().data("type");$(t).find(".qi").each(function(e,t){var i=$(t).find('input[type="text"]:first').val();if(i)if("multiple"===a){let e=100/(0!=n?n:1);e=0<Number(String(e).split(".")[1])?e.toFixed(3):Math.round(e),o=o+"~%"+($(t).find('input[type="checkbox"]:first').is(":checked")?"":"-")+e+"%"+i+"\n"}else"single"===a&&(t=$(t).find('input[type="checkbox"]:first').is(":checked"),o=o+(!l&&t?"=":"~")+i+"\n",l=l||t)}),o+="}\n\n"}}).promise().done(function(){o?function(e,t,i="text/plain"){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),n.href=window.URL.createObjectURL(new Blob([e],{type:i})),n.setAttribute("download",t),n.click(),window.URL.revokeObjectURL(n.href),document.body.removeChild(n)}(o,e):M.toast({classes:"alert",html:'<span>Нет данных для сохранения</span><button class="btn-flat toast-action" onclick = "M.Toast.dismissAll();"><i class="material-icons">close</i></button>'})})}return{init:function(){n(!1),$("#fakeinpfile, #m_fakeinpfile").on("click",function(){t(),$("#inputfile").click()}),$("#inputfile").on("change",function(){e=this.files[0].name,e=e.split(".")[0]+".gift",i(this)}),$("#outputfile, #m_outputfile").on("click",function(){o()}),$("#clearQuiz").on("click",function(){t()}),$("#wrapper").on("scroll",function(e){$(e.target).scrollTop()<=10?$(".gotop").fadeOut():$(".gotop").fadeIn()}),$("#m_qlist").on("click",function(){var e;$("#slide-list").empty(),$("#qlist").text()&&(e=$("#qlist").html(),$("#slide-list").append(e),$("#slide-list").sidenav("open"))}),$(".modal").modal(),$(".sidenav").sidenav()},deleteItem:function(e){$(e).parent().remove()},deleteQuestion:function(e,t){$("#ql"+t).remove(),$(e).parent().parent().parent().remove()},addNewQuestion:function(){QuizQuestions={qid:l,qname:"",qitem:[],type:"single"},QuizQuestions.qitem.push({text:"",result:!1}),QuizQuestions.qitem.push({text:"",result:!1}),a(QuizQuestions),$("#qw"+l).find(".qn:first").focus(),$("#wrapper").animate({scrollTop:$("#wrapper").prop("scrollHeight")},500),l++},addItem:function(e){$(e).parent().before('<div class="qi valign-wrapper offset-s2 col s9"><p><label><input type="checkbox"><span><input type="text" value=""></span></label></p><a nohref="" title="Удалить" class="control-item-delete" onclick="moodlequizeditor.deleteItem(this)"><i class="material-icons">highlight_off</i></a></div>')},changeList:function(e,t){$("#ql"+t).children("a:first").text($(e).val())}}}();$(document).ready(function(){moodlequizeditor.init()});